<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>AR Navigation Demo</title>
  <style>
    html,body{height:100%;margin:0;background:#000;overflow:hidden;font-family:sans-serif;}
    #message{position:fixed;left:50%;top:15px;transform:translateX(-50%);color:#fff;
      background:rgba(0,0,0,0.5);padding:6px 14px;border-radius:8px;font-size:14px;z-index:100;}
    canvas{display:block;touch-action:none;}
  </style>
</head>
<body>
<div id="message">در حال آماده‌سازی محیط AR...</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';

let camera, scene, renderer, controller;
const clock = new THREE.Clock();
const objects = [];
const message = document.getElementById('message');

// show message temporarily
function showMsg(txt, t=3000){
  message.textContent = txt;
  clearTimeout(message._t);
  message._t = setTimeout(()=>message.textContent='', t);
}

// initialize scene
function initThree(){
  renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 100);
  scene.add(new THREE.AmbientLight(0xffffff,0.8));
  const light = new THREE.DirectionalLight(0xffffff,1.0);
  light.position.set(1,2,1);
  scene.add(light);

  window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
}

// create an arrow with texture
function createArrow(label="پیکان"){
  const group = new THREE.Group();

  const texLoader = new THREE.TextureLoader();
  const arrowTex = texLoader.load('arrow.png');
  const signTex = texLoader.load('sign.png');

  const arrowMat = new THREE.MeshBasicMaterial({map:arrowTex, transparent:true});
  const arrow = new THREE.Mesh(new THREE.PlaneGeometry(0.3,0.3), arrowMat);
  arrow.rotation.x = -Math.PI/2;
  group.add(arrow);

  const signMat = new THREE.MeshBasicMaterial({map:signTex, transparent:true});
  const sign = new THREE.Mesh(new THREE.PlaneGeometry(0.4,0.2), signMat);
  sign.position.set(0,0.25,0);
  group.add(sign);

  group.userData = {
    basePos:new THREE.Vector3(),
    colorFactor:0 // smooth color transition
  };

  return group;
}

// tap handler to place arrow
function onSelect(){
  const raycaster = new THREE.Raycaster();
  const tempMatrix = new THREE.Matrix4().identity().extractRotation(controller.matrixWorld);
  raycaster.ray.origin.setFromMatrixPosition(controller.matrixWorld);
  raycaster.ray.direction.set(0, 0, -1).applyMatrix4(tempMatrix);

  const pos = new THREE.Vector3();
  pos.setFromMatrixPosition(controller.matrixWorld);
  const dir = new THREE.Vector3(0,0,-1).applyMatrix4(tempMatrix).multiplyScalar(0.6);
  pos.add(dir);

  const obj = createArrow(`پیکان ${objects.length+1}`);
  obj.position.copy(pos);
  obj.userData.basePos.copy(pos);
  scene.add(obj);
  objects.push(obj);

  showMsg(`پیکان ${objects.length} افزوده شد`);
}

// animate arrows based on distance
function animateObjects(delta){
  for(const o of objects){
    const dist = camera.position.distanceTo(o.position);

    // smooth color interpolation
    const targetFactor = dist < 1.0 ? 1 : 0; // 1 = near (gold), 0 = far (blue)
    o.userData.colorFactor += (targetFactor - o.userData.colorFactor) * delta * 3;

    const mixColor = new THREE.Color(0x2196f3).lerp(new THREE.Color(0xffd700), o.userData.colorFactor);

    for(const mesh of o.children){
      if(mesh.material.map) mesh.material.color.copy(mixColor);
    }

    // keep facing camera smoothly
    o.lookAt(camera.position);
  }
}

// start AR session
async function startAR(){
  if(!renderer) initThree();
  const arButton = ARButton.createButton(renderer, {requiredFeatures: []});
  arButton.style.display='none';
  document.body.appendChild(arButton);

  renderer.setAnimationLoop(render);
  const started = await new Promise(resolve=>{
    renderer.xr.addEventListener('sessionstart',()=>resolve(true));
    renderer.xr.addEventListener('sessionend',()=>resolve(false));
    arButton.click();
  });

  if(!started){ showMsg('AR شروع نشد'); return; }

  controller = renderer.xr.getController(0);
  controller.addEventListener('select', onSelect);
  scene.add(controller);

  showMsg('برای افزودن پیکان در هر جهت لمس کن');
}

function render(){
  const delta = clock.getDelta();
  animateObjects(delta);
  renderer.render(scene, camera);
}

initThree();
startAR();
</script>
</body>
</html>
